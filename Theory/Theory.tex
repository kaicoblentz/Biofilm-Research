\documentclass[letterpaper, twoside]{article}
\usepackage[utf8]{inputenc}
\usepackage{fullpage}
\usepackage{amssymb}
\usepackage{amsmath}
\usepackage{graphicx}
\usepackage{xcolor}
\numberwithin{equation}{section}

% Text
\newcommand{\etc}{etc.}
\newcommand{\eg}{e.g.}
\newcommand{\ie}{i.e.}

\title{Biofilm Model Theory}
\author{Austen, Takumi, Mark, Phil}
\date{}

\begin{document}
\maketitle
\abstract{Summary of theory used in biofilm model.}

\section{Nomenclature}
\begin{tabular}{c l c}
  Variable & Description & Units\\ \hline
  $\mu_\mathrm{max}$  & Maximum specific growth rate & 1/days\\
  $K_m$ & Monod half saturation coefficient & g/m$^3$\\
  $Y_\mathrm{xs}$ & Biomass yield coefficient on substrate & g$\cdot$g/s\\
  $V$ & Volume &m$^3$ \\
  $Q$	& Flowrate & m$^3$/day\\
  $S_A$	& Wetted surface area & m$^2$\\
  $S_{\mathrm{in}}$ & Influent substrate concentration &  g/m$^3$ \\
  $S_o$ & Initial bulk fluid substrate concentration in tank &  g/m$^3$ \\
  $X_o$ & Initial biomass concentration in tank &  g/m$^3$ \\
  $D_\mathrm{aq}$ & Diffusion coefficient of substrate in water & m$^2$/day \\
  $D_e$ & Effective diffusion coefficient of substrate in biofilm & m$^2$/day \\
  $X_b$ & Biomass density in biofilm &  g/m$^3$ \\
  $L_{f}$ & Biofilm thickness & m\\
  $L_L$ & Concentration boundary layer thickness & m \\
  $k_\mathrm{det}$ &	Detachment rate coefficient & 1/(m$\cdot$days)
\end{tabular}

\section{Tank Environment}
The environment is modeled in this function as a rectangular tank holding the bulk liquid, with the existence of an inflow and outflow which carries biomass and substrate into the bulk liquid. The concentration rates of the biomass and substrate are modeled by the following ordinary differential equations
\begin{equation} \label{eq: BiomassEquation}
  \frac{dx}{dt} = \left(\mu(S) - \frac{Q}{V}\right) x +\frac{ V_{\mathrm{det}} S_A X_b}{V},
\end{equation}
\begin{equation} \label{eq: SubstrateEquation}
  \frac{dS}{dt} = -\frac{\mu(S) x}{Y_{xs}} + \frac{Q S_{\mathrm{in}}}{V} - \frac{Q S}{V} - \frac{S_A B_{\mathrm{flux}}}{V}.
\end{equation}
with initial condition $x(t=0)=x_o$ and $S(t=0)=S_o$.

These two ordinary differential equations are packaged into a function f
\begin{equation} \label{eq: ODEpackagef}
  f(t,y) = \left[\frac{dx}{dt}\left(y(1), t, y(2), V_\mathrm{det}\right) , 
	      \frac{dS}{dt}\left(y(1), t, y(2)\right)\right]
\end{equation}

A 4th Order Runge-Kutta Method is used to discretize and solve the packed differential equations in this function. The Runge-Kutta Numerical Method calculates the slope of function at four points between each step of the iteration process in order to boost the accuracy of the next-point estimation. The first of these four slope calculations is the most simple, and occurs at the beginning of the interval,
\begin{equation} \label{eq: S_1}
  S_1 = f(t_n,y_n).
\end{equation}

The next slope estimation occurs at the midpoint of the iterative step, using the slope calculated at the beginning of the interval to increase its accuracy,
\begin{equation} \label{eq: S_2}
  S_2 = f(t + \frac{1}{2} dt,y + \frac{1}{2} dt S_1)
\end{equation}

The third calculation occurs at the 3/4  point of the step,
\begin{equation} \label{eq: S_3}
  S_3 = f(t + \frac{3}{4} dt,y+\frac{3}{4} dt S_2)
\end{equation}

The final calculation of the slope at the next step uses the previous three calculations to produce the most accurate estimation of the slope possible. 
\begin{equation} \label{eq: t_{new}}
  t_{new} = t + dt
\end{equation}

\begin{equation} \label{eq: y_{new}}
  y_{new} = y + \frac{1}{9} dt (2 S_1 + 3 S_2 + 4 S_3)
\end{equation}

\begin{equation} \label{eq: S_4}
  S_4 = f(t_{new},y_{new})
\end{equation}

The final portion of each iterative step is to calculate the error of the step by comparing it to the Butcher Tableau coefficients produced by an Adaptive Runge-Kutta Method,
\begin{equation} \label{eq: errorfunction}
  \mathrm{error} = \frac{1}{72} dt (-5 S_1 + 6 S_2 + 8 S_3 - 9 S_4).
\end{equation}

This error term allows for each variable time step to be analyzed and adjusted according to its deviation from the standard timestep. This occurs by establishing thresholds for error which keep it from getting too big or too small as given for an arbitrary tolerance 'tol'.

For instance, when the timestep becomes too small,  if abs(error) $ \leq\ $ tol/100
\begin{equation}
  dt = 2 dt.
\end{equation}

When the timestep becomes too big, if abs(error) $ \geq\ $ tol
\begin{equation}
  dt = \frac{1}{2} dt.
\end{equation}

This error term maintains the variable timestep within a reasonable range during the iteration process.


\section{Tank Environment - v2}
Assuming steady-state with full penetration of substrate into biofilm, \ie, substrate concentration is a constant within the tank and biofilm.
\subsection{Biofilm Thickness}
The thickness of the biofilm is described by
\begin{equation}
  \frac{d L_f}{dt} = {\bar\mu L_f}-{k_{\mathrm{det}}L_f^2},
\end{equation}
which at steady state leads to
\begin{equation}\label{eq:Lfsteady}
{\color{red}
  {\bar\mu L_f}={k_{\mathrm{det}}L_f^2}.
}
\end{equation}

\subsection{Biomass Concentration in Tank}
Biomass in the tank is described by
\begin{equation}
  \frac{dx V}{dt} = \mu xV - Q x +V_{\mathrm{det}} S_A x_b
\end{equation}
At steady state, this equation simplifies to
\begin{align} 
  Qx = \mu xV +V_{\mathrm{det}} S_A x_b\\
   {\color{red}
  Qx = \mu xV +\mu L_f S_A x_b
  }
\end{align}
where we used $V_{\mathrm{det}}= K_\mathrm{det} L_f^2 = \mu L_f$ from Eq.~\ref{eq:Lfsteady}.

\subsection{Substrate Concentration}
The substrate concentration in the tank is described by
\begin{equation}\label{eq:sub1}
  \frac{dS V}{dt} = -\frac{\mu x V}{Y_{xs}} + Q S_{\mathrm{in}} - Q S - S_A B_{\mathrm{flux}}.
\end{equation}
The flux term $B_\mathrm{flux}$ can be computed using the growth of biomass in the biofilm, \ie,
\begin{equation}
  B_\mathrm{flux} = \int_0^{L_f} \frac{\mu(S) x_b}{Y_{xs}} \, dz = \frac{ x_b}{Y_{xs}}\int_0^{L_f} \mu(S) \, dz = \frac{ x_b}{Y_{xs}} L_f \bar{\mu}.
\end{equation}
 Using this definition of the flux, Eq.~\ref{eq:sub1} can be written as
\begin{equation}
  \frac{dS V}{dt} = -\frac{\mu x V}{Y_{xs}} + Q S_{\mathrm{in}} - Q S -\frac{\bar{\mu} x_b V_b}{Y_{xs}}
\end{equation}
where $V_b=S_A L_f$ is the volume of the biofilm.   At steady-state this simplifies to 
\begin{equation}
 {\color{red}
   x = \frac{Y_{xs}}{\mu V}\left(Q S_{\mathrm{in}} - Q S\right) -\frac{\bar{\mu} V_b}{\mu V}x_b
 }
\end{equation}




\section{Growth-rate $\mu$}\label{sec:mu}
$\mu$ represents the variable growth rate of the species within the biofilm. These equations model the consumption of substrate within the biofilm and are used in a variety of different equations, including the bulk liquid concentration rates, the biofilm thickness, and the diffusion within the biofilm.

Different equations are required to represent different growth profiles. The standard growth equation is the Monod Growth Rate
\begin{equation} \label{eq: MonodGrowthRate}
  \mu=\mu_\mathrm{max} \frac{S}{K_m + S}.
\end{equation}

There is also the Double Monod Growth Rate to model multiple substrates `a' and `b'
\begin{equation} \label{eq: DoubleMonodGrowthRate}
  \mu=\mu_\mathrm{max} \frac{S_a}{K_{ma} + S_a} \frac{S_b}{K_{mb} + S_b}.
\end{equation}

The final equation that may be used is an Inhibition Model
\begin{equation} \label{eq: Inhibition}
  \mu=\mu_\mathrm{max} \frac{S_a}{K_{ma} + S_a} \frac{1}{1 + \frac{S_b}{K_{mb}}}.
\end{equation}

The $\mu$ function `mu' defines all these equations and allows for the desired growth rate to be called throughout the rest of the code when needed.
  

\section{Biofilm Diffusion}
Substrates that exist within the tank will diffuse into the biofilm.  The diffusion process is described by
\begin{equation} \label{eq:diffusion}
  \frac{d^2 S_b}{dz^2} = \frac{\mu(S_b) X_b}{Y_{xs} D_e}.
\end{equation}
This differential equation is, typically, non-linear due the growth-rate $\mu$.

\subsection{Discretization and Linearization}
To solve it we use the direct, finite-difference method, which leads to the following discretized equation
\begin{equation} \label{eq:diff_dis}
  \frac{ S_{b,i-1} - 2 S_{b,i} + S_{b,i+1}}{dz^2} = \frac{\mu(S_{b,i}) X_b}{Y_{xs} D_e},
\end{equation}
which is valid at all the interior grid points, \ie, for $i=2,3,\dots,N_z-1$. 
This non-linear equation is solved by linearizing and then iterating the solution from an initial guess until converged.
The iterations are denoted by a superscript, \ie, $S_{b}^{(k)}$.  With this notation Eq.~\ref{eq:diff_dis} becomes
\begin{equation} \label{eq:diff_dis_iter}
  \frac{ S_{b,i-1}^{(k)} - 2 S_{b,i}^{(k)} + S_{b,i+1}^{(k)}}{\Delta z^2} = \frac{\mu\left(S_{b,i}^{(k)}\right) X_b}{Y_{xs} D_e} =  g\left(S_{b,i}^{(k)}\right).
\end{equation}
where we have introduced $g$ as the right-hand-side of the equation.

To linearize this equation, we employ the Taylor series of $g$ about the previous iteration $S_{b,i}^{(k-1)}$ which is
\begin{equation}\label{eq:TaylorSeries}
  g\left(S_{b,i}^{(k)}\right) =   g\left(S_{b,i}^{(k-1)}\right) + \left( S_{b,i}^{(k)} - S_{b,i}^{(k-1)}\right) \left.\frac{d g}{d S_b}\right|_{S_{b,i}^{(k-1)}} + \dots
\end{equation}

Combining Eqs.~\ref{eq:diff_dis_iter} and~\ref{eq:TaylorSeries} and keeping only the linear terms in the Taylor series leads to
\begin{equation} \label{eq:diff_linear}
  \frac{ S_{b,i-1}^{(k)} - 2 S_{b,i}^{(k)} + S_{b,i+1}^{(k)}}{\Delta z^2} =  g\left(S_{b,i}^{(k-1)}\right) + \left( S_{b,i}^{(k)} - S_{b,i}^{(k-1)}\right) \left.\frac{d g}{d S_b}\right|_{S_{b,i}^{(k-1)}} 
\end{equation}
which is linear with-respect-to $S_{b,i}^{(k)}$ and can be rearranged to
\begin{equation}
  \label{eq:diff_final}
  -S_{b,i-1}^{(k)} + \left( 2 +\Delta z^2\left.\frac{d g}{d S_b}\right|_{S_{b,i}^{(k-1)}}\right) S_{b,i}^{(k)} - S_{b,i+1}^{(k)}
  = \Delta z^2\left( S_{b,i}^{(k-1)} \left.\frac{d g}{d S_b}\right|_{S_{b,i}^{(k-1)}} - g\left(S_{b,i}^{(k-1)}\right)\right) 
\end{equation}

The derivative $\left.\frac{d g}{d S_b}\right|_{S_{b,i}^{(k-1)}}$ needs to be approximated and we use
\begin{equation}
  \label{eq:dgds}
  \left.\frac{d g}{d S_b}\right|_{S_{b,i}^{(k-1)}} = \frac{g\left(S_{b,i}^+\right) - g\left(S_{b,i}^{-}\right)}{\Delta S}
\end{equation}
where
\begin{align*}
  S_{b,i}^+&=S_{b,i}^{(k-1)}+\delta \text{\quad and} \\
  S_{b,i}^-&=\max\left[S_{b,i}^{(k-1)}+\delta,0\right]
\end{align*}
and $\Delta S = S_{b,i}^+ - S_{b,i}^-$ and $\delta=1\times 10^{-3}$ is an specified constant.  The maximum on $S_{b,i}^-$ ensures the concentration remains non-negative.

\subsection{Boundary Conditions}
Eq.~\ref{eq:diff_final} for $i=2,3,\dots,N_z-1$ provides $N_z-2$ equations for $S_{b}^{(k)}$.  The remaining equations come from the boundary conditions.  At the bottom of the biofilm ($z=0$) there is a wall and a no-flux boundary condition is appropriate, \ie,
\begin{equation}
  \label{eq:BC1}
  \left.\frac{d S_b}{dz}\right|_{z=0}= \frac{S_2 - S_1}{\Delta z} =0.
\end{equation}

At the top of the biofilm the substrate is diffusing from the tank into the biofilm.  Depending on the conditions in the tank, \eg, how well it is mixed, the flux of substrate into the biofilm may be controlled by the diffusion through the liquid in the tank.  This leads to a flux-matching condition that can be written as
\begin{equation}
  \label{eq:BC2}
  D_e \left.\frac{d S_b}{dz}\right|_{z=L_f} = D_{\mathrm{aq}} \frac{S - S_b(L_f)}{L_L}.
\end{equation}
where a simple diffusion model through the liquid has been used.  Discretizing the derivative using a finite-difference operator leads to
\begin{equation}
  \label{eq:BC2_dis}
  D_e \frac{S_{b,N_z} - S_{b,N_z-1}}{\Delta z} = D_{\mathrm{aq}} \frac{S - S_{b,N_z}}{L_L}.
\end{equation}
Rearranging leads to
\begin{equation}
  \label{eq:BC2_dis2}
  \left(D_e L_l + D_{\mathrm{aq}} \Delta z\right) S_{b,N_z} - D_e L_l S_{b,N_z-1} = D_{\mathrm{aq}} \Delta z S
\end{equation}
which is a useful form because if $L_l=0$ it simplifies to $S_{b,N_z}=S$ as expected without dividing by zero.

\subsection{Solution of System of Equations}
The previous two section describe the equations used to solve the diffusion problem through
the biofilm and apply appropriate boundary conditions.
In summary, Eq.~\ref{eq:diff_linear} for $i=2,3,\dots,N_z-1$ provides $N_z-2$ equations with
Eq.~\ref{eq:BC1} and Eq.~\ref{eq:BC2_dis2} providing the two other equations
for a total of $N_z$ equations for the $N_z$ unknowns $S_{b,i}$ for $i=1,\dots,N_z$.

The $N_z$ equations are solved by iteratively solving for $S_b$ using the matrices
\begin{equation}
  \label{eq:system}
  \renewcommand*{\arraystretch}{1.5}
  \begin{bmatrix}
    1 &-1  &   &   &   & \\
    L &  D & U &  &   & \\
    ~ & L &  D & U &  & \\
    ~ & ~ & \ddots &  \ddots & \ddots & \\
    ~ & ~ & ~ & L &  D & U\\
    ~ & ~ & ~ & ~ &  C_1 & C_2  
  \end{bmatrix}
  \begin{bmatrix}
    S_{b,1}^{(k)}\\
    S_{b,2}^{(k)}\\
    S_{b,3}^{(k)}\\
   \vdots\\
    S_{b,N_z-1}^{(k)}\\
    S_{b,N_z}^{(k)}
  \end{bmatrix}
  =
    \begin{bmatrix}
   0\\
    R_{2}\\
    R_{3}\\
    \vdots\\
    R_{N_z-1}\\
    C_3
  \end{bmatrix}
\end{equation}
The first row comes from Eq.~\ref{eq:BC1}.
The second through $N_z-1$ rows are Eq.~\ref{eq:diff_final} written with $i=2,\dots,N_z-1$ and the constants are $L=U=-1$,
\begin{align*}
  D&=\left( 2 +\Delta z^2\left.\frac{d g}{d S_b}\right|_{S_{b,i}^{(k-1)}}\right)\text{\quad and}\\
  R_i&=\Delta z^2\left( S_{b,i}^{(k-1)} \left.\frac{d g}{d S_b}\right|_{S_{b,i}^{(k-1)}} - g\left(S_{b,i}^{(k-1)}\right)\right) 
\end{align*}
The last row is Eq.~\ref{eq:BC2_dis2} with $C_1=D_e L_l$, $C_2=\left(D_e L_l + D_{\mathrm{aq}} \Delta z\right)$, and $C_3=D_{\mathrm{aq}} \Delta z S$.

The right-hand-side depends $S_{b,i}^{(k-1)}$, which is the concentration at the previous iteration.  The solution process is started with a guess, e.g., $S_b=0$. Iteration continues until
\begin{equation*}
  \max\left| S_{b,i}^{(k)} - S_{b,i}^{(k-1)} \right| < \mathrm{tol},
\end{equation*}
for a specified tolerance $\mathrm{tol}$.

\section{Biofilm Thickness}
With the current time-step's substrate concentrations throughout the thickness of the biofilm computed, the new thickness of the biofilm may now be computed by solving the first order differential equation

\begin{equation}
  \label{eq:dLfdt_1}
  \frac{d L_f}{dt} = {\bar\mu L_f}-{k_{\mathrm{det}}L_f^2},
\end{equation}
in which the first term of the right hand side is equal to the growth velocity and the second term is equal to the detachment velocity of the biofilm's biomass. 

\begin{equation}
  \label{eq:vg}
  v_g={\bar\mu L_f}
\end{equation}

\begin{equation}
  \label{eq:vdet}
  v_{det}={k_{\mathrm{det}}L_f^2}
\end{equation}

Eq.~\ref{eq:dLfdt_1} is discretized and a future time step's solution is obtained using Euler's method and the information known at the current time step. The resulting expression is as follows, where the superscript $\ie L_f^{t}$ denotes the biofilms state at the respective time-step.

\begin{equation}
  \label{eq:dLfdt_2}
  {L_f^{t+1}}={L_f^{t}} + {\Delta t}({v_g^{t}+v_{det}^{t}})
\end{equation}

\subsection{Growth Velocity}
Since the growth rate $\mu$ is specified as an average value within the biofilm in Eq.~\ref{eq:vg}, and the specifics of the growth rate at each point within the biofilm depends on $\mu$ and $S_b$ a result for the growth velocity within the biofilm is obtained by numerically evaluating the integral 

\begin{equation}
  \label{eq:vg_int}
  {v_g^{t}}={\int_{0}^{L_f^{t}}\mu(S_b(z)^{t})dz}.
\end{equation}

Using trapezoidal integration, Eq.~\ref{eq:vg_int} becomes

\begin{equation}
  \label{eq:vg_sum}
  {v_g^{t}}={\sum_{i=1}^{N_{z-1}}  {\frac{\Delta {z^{t}}}{2}}  ( {\mu({S_{b,i}^{t}})+\mu({S_{b,i+1}^{t}})}}).
\end{equation}

\subsection{Detachement Velocity}
The detachment velocity of biomass from the biofilm is computed as follows
\begin{equation}
  \label{eq:vdet2}
  {v_{det}^{t}}={k_{\mathrm{det}}{L^t_f}^2}.
\end{equation}

\section{Test Cases for Validity}
In order to determine the accuracy of the methods and equations used in this model, test cases were created to monitor each respective method and its corresponding results.

\subsection{Test for when LL=0}

\subsection{Test for Solution of Diffusion Problem}

\subsection{Test for Tank Biomass Concentration when no Inflow Q}

\subsection{Test for Tank Substrate Concentration when no Inflow Q}

\subsection{Test Diffusion}

\subsection{Test Steady-State with Large Diffusivities such that Substrate Concentration is Relatively Constant}

\subsection{Test Variable Time Dynamic of Tank Environment Calculations}



\end{document}